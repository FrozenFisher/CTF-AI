# 训练可视化使用指南

## 快速开始

### 方法1：使用监控脚本（推荐）

同时启动训练和可视化：

```bash
cd saved/CTF/backend
./training/monitor_training.sh 8082
```

这会：
- 启动训练进程（后台运行）
- 启动可视化监控（实时显示图表）
- 自动保存训练统计和图表

### 方法2：分别启动

**终端1 - 启动训练：**
```bash
cd saved/CTF/backend
python3 training/train_self_play.py 8082
```

**终端2 - 启动可视化：**
```bash
cd saved/CTF/backend
python3 training/visualize_training.py lib/models/training_stats.json 5
```

## 可视化内容

可视化脚本会显示4个图表：

1. **Episode奖励趋势**
   - 原始奖励值（蓝色，半透明）
   - 20期移动平均（红色，粗线）
   - 用于观察奖励是否提升

2. **训练损失趋势**
   - 原始损失值（橙色，半透明）
   - 20期移动平均（红色，粗线）
   - 用于观察模型是否收敛

3. **胜率趋势**
   - 胜率变化（绿色，半透明）
   - 20期移动平均（红色，粗线）
   - 50%基准线（灰色虚线）
   - 用于观察对战能力提升

4. **统计信息面板**
   - 总Episode数
   - 胜负平统计
   - 最近10局平均奖励和损失
   - 当前探索率(ε)
   - **训练建议**（最重要！）

## 何时终止训练？

根据可视化结果和训练建议：

### ✅ 可以停止训练的情况：

1. **胜率 ≥ 80%**
   - 模型表现优秀
   - 建议：保存模型，可以停止训练

2. **胜率 ≥ 60% 且稳定**
   - 模型表现良好
   - 建议：如果胜率在最近20局中稳定，可以停止

3. **奖励收敛且损失稳定**
   - 奖励移动平均线趋于平稳
   - 损失 < 0.1 且波动小
   - 建议：模型可能已收敛，可以停止

4. **Episode ≥ 200 且胜率 ≥ 70%**
   - 训练时间足够
   - 表现稳定
   - 建议：可以停止训练

### ⚠️ 需要继续训练的情况：

1. **胜率 < 50%**
   - 模型表现不佳
   - 建议：继续训练至少100个episode

2. **奖励波动大**
   - 标准差 > 50
   - 建议：继续训练直到稳定

3. **损失 > 1.0**
   - 损失较高
   - 建议：可能需要调整学习率，继续训练

4. **Episode < 50**
   - 训练初期
   - 建议：至少训练到100个episode

### 📊 关键指标解读

- **胜率**: 最重要的指标，反映模型实际对战能力
  - ≥80%: 优秀
  - 60-80%: 良好
  - 50-60%: 一般
  - <50%: 需要改进

- **奖励**: 反映模型学习效果
  - 上升趋势: 模型在学习
  - 平稳: 可能已收敛
  - 下降: 可能过拟合或需要调整

- **损失**: 反映模型训练稳定性
  - <0.1: 很好
  - 0.1-0.5: 正常
  - >1.0: 需要关注

- **Epsilon**: 探索率
  - 接近0.01: 探索基本结束，主要利用
  - 较高: 仍在探索阶段

## 文件说明

- `lib/models/training_stats.json` - 训练统计数据（JSON格式）
- `lib/models/training_plot.png` - 训练图表（自动保存）
- `models/dqn_model_latest.pth` - 最新模型
- `models/dqn_model_ep{N}.pth` - 每10个episode的检查点

## 使用训练好的模型

在 `server.py` 中设置：

```python
USE_RL = True
RL_MODEL_PATH = "./models/dqn_model_latest.pth"
```

然后运行：
```bash
python3 server.py $CTF_PORT_BACKEND1
```

## 注意事项

1. 可视化需要matplotlib库：`pip install matplotlib`
2. 图表每5秒自动更新
3. 按Ctrl+C停止监控
4. 训练统计每10个episode自动保存
5. 建议至少训练50个episode再判断是否需要停止

